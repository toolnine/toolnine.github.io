<!-- START OF FILE: tools/document-scanner.html (Upgraded) -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- SEO OPTIMIZATION -->
    <title>Document Scanner Online | Convert Images to PDF | ToolNine</title>
    <meta name="description" content="Use your device camera to scan documents or upload images, apply filters, and convert multiple pages into a single high-quality PDF. Privacy-friendly and in-browser processing." />
    <!-- END SEO OPTIMIZATION -->
    <!-- Updated to root-relative path -->
    <link rel="stylesheet" href="/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">
    <!-- External Libraries (keep as before) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- Include Sortable.js for drag and drop reordering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        /* Tool-specific styles based on the common layout */
        .tool-page {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 2rem;
            flex-grow: 1;
            width: 100%;
        }
        .tool-page .tool-card {
            max-width: 700px;
            padding: 2rem;
            width: 100%;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05);
            background: var(--card);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }
        .tool-header { text-align: center; margin-bottom: 1.5rem; }
        .tool-header h1 { font-size: 2rem; color: var(--accent); font-weight: 700; }
        .tool-header .tool-desc { font-size: 1rem; color: #475569; max-width: 650px; margin: 0 auto; line-height: 1.5; }
        [data-theme="dark"] .tool-header .tool-desc { color: #94a3b8; }

        /* --- Custom UI for Scanner --- */
        .scanner-controls { display: flex; flex-wrap: wrap; justify-content: center; gap: 1rem; margin-top: 1.5rem; }
        .scanner-video-container { width: 100%; max-width: 600px; margin-top: 1rem; position: relative; }
        .scanner-video-container video { width: 100%; border-radius: 8px; border: 1px solid var(--border-color); }
        .scanner-image-previews { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 1rem; justify-content: center; }
        
        /* New: Image thumbnail item styles */
        .preview-thumb-item {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            cursor: move;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .preview-thumb-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .preview-thumb-item .remove-btn {
            position: absolute;
            top: 0;
            right: 0;
            background: rgba(239, 68, 68, 0.8);
            color: white;
            border: none;
            cursor: pointer;
            width: 20px;
            height: 20px;
            line-height: 20px;
            text-align: center;
            border-bottom-left-radius: 6px;
            font-size: 0.8em;
            opacity: 0.8;
        }
        .preview-thumb-item .remove-btn:hover { opacity: 1; }

        /* --- Upload Drop Zone (reused from image-to-pdf) --- */
        .upload-drop-zone {
            border: 2px dashed var(--accent);
            border-radius: 8px;
            background: var(--card);
            text-align: center;
            transition: border-color 0.2s, background 0.2s;
            padding: 2rem 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            font-size: 1.05em;
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .upload-drop-zone:hover, .upload-drop-zone.active {
            border-color: #1e40af;
            background: #e0ebff;
        }
        [data-theme="dark"] .upload-drop-zone { background: #334155; }
        [data-theme="dark"] .upload-drop-zone:hover, [data-theme="dark"] .upload-drop-zone.active { background: #475569; border-color: #60a5fa; }
        .upload-drop-zone .add-icon { font-size: 2.5em; color: var(--accent); margin-bottom: 0.35em; pointer-events: none; }
        .upload-drop-zone input[type="file"] { display: none; }
        .upload-drop-zone .drop-hint { font-size:0.9em;color:#888;margin-top:0.5em;}
        
        /* New: Image processing controls */
        .image-process-controls { display: flex; justify-content: center; flex-wrap: wrap; gap: 0.5rem; margin-top: 1rem; }
        .image-process-controls button { font-size: 0.9em; padding: 0.5rem 1rem; }

        /* Results area with dynamic buttons */
        .result-actions { display: none; justify-content: center; gap: 1rem; margin-top: 1rem; }
    </style>
</head>
<body>

    <!-- 1. Header Placeholder -->
    <div id="header-placeholder"></div>

    <main class="content tool-page">
        <section class="tool-card">
            <header class="tool-header">
                <h1>ðŸ“‘ Document Scanner</h1>
                <p class="tool-desc">Use your camera or upload images to scan documents and save as PDF. Capture multiple pages and convert in one click.</p>
            </header>

            <!-- File Upload Area -->
            <div class="upload-drop-zone" id="dropZone">
                <span class="add-icon">+</span>
                <span style="font-weight:500;">Add images or drag & drop</span>
                <input type="file" id="files" accept="image/*" multiple>
                <div class="drop-hint">Supported formats: JPG, PNG</div>
            </div>

            <!-- Camera Video Feed Area -->
            <div class="scanner-video-container">
                <video id="camera" autoplay playsinline style="display:none;"></video>
                <canvas id="canvasPreview" style="display: none;"></canvas> <!-- Canvas for filters and preview -->
            </div>

            <!-- Controls -->
            <div class="scanner-controls">
                <button class="btn" id="camBtn">Start Camera</button>
                <button class="btn" id="capBtn" style="display:none">Capture Page</button>
            </div>

            <!-- New: Image Processing Controls (Filters) -->
            <div class="image-process-controls" id="imageProcessControls" style="display:none;">
                <button class="btn" id="noFilterBtn">Original</button>
                <button class="btn" id="documentClearBtn">Document Clear</button>
                <button class="btn" id="grayBtn">Greyscale</button>
            </div>
            
            <button class="btn" id="makePdf" disabled style="margin-top: 1rem;">Generate PDF</button>

            <!-- Image Previews -->
            <div id="thumbs" class="scanner-image-previews"></div>

            <!-- New: Results actions -->
            <div class="result-actions" id="resultActions">
                <a class="btn" id="downloadPdfLink">Download PDF</a>
                <a class="btn" id="downloadZipLink">Download Images (ZIP)</a>
                <button class="btn" id="shareBtn">Share PDF</button>
                <button class="btn" id="clearAllBtn">Clear All</button> <!-- NEW CLEAR BUTTON -->
            </div>

        </section>

        <section class="how-to">
            <h3>How to Use</h3>
            <ol>
                <li>Click "Start Camera" to capture documents using your device's camera.</li>
                <li>(New) Use the live filter controls to improve contrast and readability for documents.</li>
                <li>For each page, click "Capture Page" or add an image file.</li>
                <li>(New) Drag and drop the thumbnails to reorder pages in the sequence you want.</li>
                <li>Click "Generate PDF" to create a single PDF containing all captured pages.</li>
                <li>Download or share the final document.</li>
            </ol>
        </section>
    </main>

    <!-- PWA Install Button -->
    <div class="pwa-install-container">
        <button class="btn" id="installButton" style="display:none;">Install App</button>
    </div>

    <!-- Footer Placeholder -->
    <div id="footer-placeholder"></div>

    <!-- Scripts -->
    <!-- NEW: Load the component loader script first -->
    <script src="/js/load-components.js"></script>
    <!-- Keep existing scripts here -->
    <script src="/theme.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Elements ---
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('files');
            const cameraVideo = document.getElementById('camera');
            const canvasPreview = document.getElementById('canvasPreview'); // NEW canvas for live filter preview
            const camBtn = document.getElementById('camBtn');
            const capBtn = document.getElementById('capBtn');
            const makePdfBtn = document.getElementById('makePdf');
            const thumbsContainer = document.getElementById('thumbs');
            const resultActionsContainer = document.getElementById('resultActions');
            const downloadPdfLink = document.getElementById('downloadPdfLink');
            const downloadZipLink = document.getElementById('downloadZipLink');
            const clearAllBtn = document.getElementById('clearAllBtn'); // NEW clear button

            const filterControls = document.getElementById('imageProcessControls');
            const noFilterBtn = document.getElementById('noFilterBtn');
            const documentClearBtn = document.getElementById('documentClearBtn');
            const grayBtn = document.getElementById('grayBtn');

            // --- State Variables ---
            let capturedImages = []; // Array of { dataURL, fileName, id } objects
            let currentFilter = 'original'; // Current filter to apply to capture
            let stream = null; // Camera video stream

            // --- UI Reset and State Management ---
            function updateUIState() {
                makePdfBtn.disabled = capturedImages.length === 0;
                resultActionsContainer.style.display = capturedImages.length > 0 ? 'flex' : 'none';
                dropZone.style.display = capturedImages.length === 0 ? 'flex' : 'none';
            }

            function clearAll() {
                capturedImages = [];
                thumbsContainer.innerHTML = '';
                stopCamera();
                updateUIState();
            }

            // --- Image Handling Functions ---
            // 1. Drag & Drop / File Upload Logic
            dropZone.addEventListener('click', () => fileInput.click());
            dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('active'); });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('active'));
            dropZone.addEventListener('drop', e => {
                e.preventDefault();
                dropZone.classList.remove('active');
                handleImageFiles(e.dataTransfer.files);
            });
            fileInput.addEventListener('change', e => handleImageFiles(e.target.files));

            function handleImageFiles(files) {
                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        addImageToPreviews(reader.result, file.name);
                    };
                    reader.readAsDataURL(file);
                });
            }

            // 2. Camera Logic
            camBtn.addEventListener('click', () => {
                if (stream) {
                    stopCamera();
                } else {
                    startCamera();
                }
            });

            async function startCamera() {
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    cameraVideo.srcObject = stream;
                    cameraVideo.style.display = 'block';
                    dropZone.style.display = 'none';
                    filterControls.style.display = 'flex';
                    camBtn.textContent = 'Stop Camera';
                    capBtn.style.display = 'block';
                    // Apply live filter preview (optional, requires canvas preview)
                    // We'll use a canvas element to apply filters live on the video stream
                    setupLiveFilterPreview();
                } catch (err) {
                    alert('Error starting camera. Please ensure camera access is allowed.');
                    console.error('Camera access error:', err);
                }
            }

            function stopCamera() {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
                cameraVideo.style.display = 'none';
                capBtn.style.display = 'none';
                camBtn.textContent = 'Start Camera';
                dropZone.style.display = 'flex'; // Show drop zone again
                filterControls.style.display = 'none';
                canvasPreview.style.display = 'none'; // Hide live filter canvas
            }

            // 3. Capture Logic
            capBtn.addEventListener('click', () => {
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = cameraVideo.videoWidth;
                tempCanvas.height = cameraVideo.videoHeight;
                const ctx = tempCanvas.getContext('2d');
                ctx.drawImage(cameraVideo, 0, 0, tempCanvas.width, tempCanvas.height);

                // Apply current filter and save
                applyFilterToCanvas(tempCanvas, currentFilter);

                const dataUrl = tempCanvas.toDataURL('image/png');
                const uniqueId = Date.now();
                addImageToPreviews(dataUrl, `scan_${uniqueId}.png`);
            });

            // 4. Filter Logic (NEW)
            function setupLiveFilterPreview() {
                const video = document.getElementById('camera');
                const canvas = document.getElementById('canvasPreview');
                const ctx = canvas.getContext('2d');

                // Set initial size and hide video, show canvas
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                video.style.display = 'none';
                canvas.style.display = 'block';

                function renderLoop() {
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    applyFilterToCanvas(canvas, currentFilter);
                    requestAnimationFrame(renderLoop);
                }
                video.onloadedmetadata = renderLoop;
            }

            // Apply filter to canvas data (grayscale, contrast adjustment for document clear)
            function applyFilterToCanvas(canvas, filterType) {
                const ctx = canvas.getContext('2d');
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;

                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];

                    if (filterType === 'gray') {
                        const gray = 0.299 * r + 0.587 * g + 0.114 * b;
                        data[i] = gray;
                        data[i + 1] = gray;
                        data[i + 2] = gray;
                    } else if (filterType === 'documentClear') {
                        // Advanced filter (simple thresholding and contrast increase)
                        const gray = 0.299 * r + 0.587 * g + 0.114 * b;
                        const contrast = 1.8; // Adjust contrast factor
                        const brightness = 10; // Adjust brightness offset
                        let newGray = (gray * contrast) + brightness;
                        if (newGray > 255) newGray = 255;
                        if (newGray < 0) newGray = 0;
                        data[i] = newGray;
                        data[i + 1] = newGray;
                        data[i + 2] = newGray;
                    }
                }
                ctx.putImageData(imageData, 0, 0);
            }

            // Filter button event listeners
            noFilterBtn.addEventListener('click', () => { currentFilter = 'original'; noFilterBtn.classList.add('active'); documentClearBtn.classList.remove('active'); grayBtn.classList.remove('active'); });
            documentClearBtn.addEventListener('click', () => { currentFilter = 'documentClear'; documentClearBtn.classList.add('active'); noFilterBtn.classList.remove('active'); grayBtn.classList.remove('active'); });
            grayBtn.addEventListener('click', () => { currentFilter = 'gray'; grayBtn.classList.add('active'); noFilterBtn.classList.remove('active'); documentClearBtn.classList.remove('active'); });

            // 5. Add Image to Previews (with reordering support)
            function addImageToPreviews(dataUrl, fileName) {
                const uniqueId = Date.now();
                capturedImages.push({ dataURL: dataUrl, fileName: fileName, id: uniqueId });

                const itemDiv = document.createElement('div');
                itemDiv.className = 'preview-thumb-item';
                itemDiv.dataset.id = uniqueId;
                itemDiv.innerHTML = `<img src="${dataUrl}" alt="${fileName}"><button class="remove-btn" data-id="${uniqueId}">&#x2715;</button>`;
                thumbsContainer.appendChild(itemDiv);

                updateUIState();
            }

            // --- Reordering Logic (using Sortable.js) ---
            new Sortable(thumbsContainer, {
                animation: 150,
                onEnd: () => {
                    // Update capturedImages array based on new order of elements in thumbsContainer
                    const newOrder = Array.from(thumbsContainer.children).map(child => parseInt(child.dataset.id));
                    const newImages = [];
                    newOrder.forEach(id => {
                        const image = capturedImages.find(img => img.id === id);
                        if (image) newImages.push(image);
                    });
                    capturedImages = newImages;
                }
            });

            // --- PDF Generation Logic ---
            makePdfBtn.addEventListener('click', async () => {
                if (capturedImages.length === 0) return alert('No images to convert.');

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const margin = 10;
                let addPage = false;

                for (let i = 0; i < capturedImages.length; i++) {
                    const imgData = capturedImages[i].dataURL;
                    const img = new Image();
                    img.src = imgData;
                    await new Promise(resolve => img.onload = resolve);

                    const imgWidth = img.width;
                    const imgHeight = img.height;
                    const ratio = imgHeight / imgWidth;

                    // Calculate dimensions to fit PDF page (A4 size: 210mm x 297mm)
                    const pdfWidth = 210 - 2 * margin;
                    const pdfHeight = pdfWidth * ratio;

                    if (addPage) {
                        doc.addPage();
                    } else {
                        addPage = true;
                    }

                    doc.addImage(imgData, 'PNG', margin, margin, pdfWidth, pdfHeight);
                }

                const pdfBlob = doc.output('blob');
                const pdfUrl = URL.createObjectURL(pdfBlob);
                downloadPdfLink.href = pdfUrl;
                downloadPdfLink.download = 'scanned_document.pdf';

                updateUIState();
            });

            // --- ZIP Download Logic ---
            downloadZipLink.addEventListener('click', async () => {
                const zip = new JSZip();
                for (let i = 0; i < capturedImages.length; i++) {
                    const image = capturedImages[i];
                    const base64Data = image.dataURL.replace(/^data:image\/png;base64,/, "");
                    zip.file(`scan_${i + 1}.png`, base64Data, { base64: true });
                }

                const zipBlob = await zip.generateAsync({ type: "blob" });
                const zipUrl = URL.createObjectURL(zipBlob);
                downloadZipLink.href = zipUrl;
                downloadZipLink.download = 'scanned_images.zip';
            });

            // --- Event Listeners ---
            thumbsContainer.addEventListener('click', (event) => {
                if (event.target.classList.contains('remove-btn')) {
                    const idToRemove = parseInt(event.target.dataset.id);
                    capturedImages = capturedImages.filter(img => img.id !== idToRemove);
                    event.target.closest('.preview-thumb-item').remove();
                    updateUIState();
                }
            });
            clearAllBtn.addEventListener('click', clearAll);

            // Initial setup call
            updateUIState();
        });
    </script>
</body>
</html>```
