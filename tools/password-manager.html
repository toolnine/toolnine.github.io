<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- SEO OPTIMIZATION -->
    <title>Password Manager | ToolNine</title>
    <meta name="description" content="A secure, privacy-first password manager that stores encrypted data locally in your browser. Generate, save, and manage passwords securely without cloud sync." />
    <!-- END SEO OPTIMIZATION -->
    <link rel="stylesheet" href="../style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">
    <!-- Include crypto-js library for encryption (Local processing) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        /* Tool-specific styles based on the common layout */
        .tool-page {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 2rem;
            flex-grow: 1;
            width: 100%;
        }
        .tool-page .tool-card {
            max-width: 700px;
            padding: 2rem;
            width: 100%;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05);
            background: var(--card);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }
        .tool-header { text-align: center; margin-bottom: 1.5rem; }
        .tool-header h1 { font-size: 2rem; color: var(--accent); font-weight: 700; }
        .tool-header .tool-desc { font-size: 1rem; color: #475569; max-width: 650px; margin: 0 auto; line-height: 1.5; }
        [data-theme="dark"] .tool-header .tool-desc { color: #94a3b8; }

        /* --- Custom UI for Password Manager --- */
        .manager-layout { display: flex; flex-direction: column; gap: 1rem; }
        .entry-list { list-style: none; padding: 0; }
        .entry-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--bg);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border: 1px solid var(--border-color);
        }
        [data-theme="dark"] .entry-item { background: #334155; }
        .entry-details strong { font-size: 1.1em; color: var(--accent); }
        .entry-details span { font-size: 0.9em; color: var(--text); }
        .entry-actions { display: flex; gap: 0.5rem; }
        .entry-actions button { padding: 0.5rem 0.8rem; font-size: 0.9em; border-radius: 6px; }

        /* Lock screen specific styles */
        #lockScreen { text-align: center; padding: 2rem; }
        #lockScreen p { margin-bottom: 1rem; }
        #masterPasswordInput { max-width: 300px; }
        #setPasswordBtn { margin-top: 1rem; }

        /* Add new password form styles */
        #addEntryForm { display: flex; flex-direction: column; gap: 1rem; }
        #addEntryForm input { font-size: 1em; }

        /* Backup/Restore controls */
        #backupRestoreControls { margin-top: 1rem; display: flex; justify-content: space-between; gap: 1rem; flex-wrap: wrap; }
        #backupRestoreControls input[type="file"] { display: none; }

        /* Responsive adjustments for entry list */
        @media (max-width: 600px) {
            .entry-item { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
            .entry-actions { width: 100%; justify-content: flex-end; }
        }
    </style>
</head>
<body>

    <header class="main-header">
        <a href="../index.html" class="logo">ToolNine</a>
        <button class="hamburger-btn" id="hamburgerBtn">‚ò∞</button>
        <nav class="main-nav">
            <ul>
                <li><a href="../index.html#category-image">Image Tools</a></li>
                <li><a href="../index.html#category-text">Text Tools</a></li>
                <li><a href="../blog.html">Blog</a></li>
            </ul>
            <button class="search-btn" id="searchBtn" aria-label="Search"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></button>
            <button class="all-tools-btn" id="allToolsBtn">All Tools <span class="arrow">‚ñº</span></button>
            <button id="theme-toggle" class="theme-btn" aria-label="Toggle dark mode">üåô</button>
        </nav>
    </header>

    <div class="mega-menu" id="allToolsMenu">
        <!-- Mega menu content (full menu) -->
        <div class="mega-menu-grid">
            <div class="mega-menu-category">
                <h3>Image Tools</h3>
                <ul>
                    <li><a href="image-to-pdf.html"><span class="tool-icon">üìÑ</span> Image to PDF</a></li>
                    <li><a href="image-compressor.html"><span class="tool-icon">üóúÔ∏è</span> Image Compressor</a></li>
                    <li><a href="image-resizer.html"><span class="tool-icon">üìè</span> Image Resizer</a></li>
                    <li><a href="convert-png-jpg.html"><span class="tool-icon">üñºÔ∏è</span> PNG <> JPG</a></li>
                    <li><a href="steganography.html"><span class="tool-icon">üïµÔ∏è</span> Steganography</a></li>
                </ul>
            </div>
            <div class="mega-menu-category">
                <h3>Text & Writing</h3>
                <ul>
                    <li><a href="text-diff.html"><span class="tool-icon">üîç</span> Text Diff</a></li>
                    <li><a href="text-encryptor.html"><span class="tool-icon">üîê</span> Text Encryptor</a></li>
                    <li><a href="text-to-pdf.html"><span class="tool-icon">üìÑ</span> Text to PDF</a></li>
                    <li><a href="word-counter.html"><span class="tool-icon">‚úèÔ∏è</span> Word Counter</a></li>
                    <li><a href="line-operations.html"><span class="tool-icon">üî†</span> Line Operations</a></li>
                    <li><a href="text-cleaner.html"><span class="tool-icon">üßπ</span> Text Cleaner</a></li>
                </ul>
            </div>
            <div class="mega-menu-category">
                <h3>Converters</h3>
                <ul>
                    <li><a href="unit-converter.html"><span class="tool-icon">‚öñÔ∏è</span> Unit Converter</a></li>
                    <li><a href="document-scanner.html"><span class="tool-icon">üìë</span> Document Scanner</a></li>
                </ul>
            </div>
            <div class="mega-menu-category">
                <h3>Encoder/Decoder</h3>
                <ul>
                    <li><a href="url-encoder.html"><span class="tool-icon">üîó</span> URL Encoder</a></li>
                    <li><a href="hash-generator.html"><span class="tool-icon">üõ°Ô∏è</span> Hash Generator</a></li>
                    <li><a href="password-manager.html"><span class="tool-icon">üîë</span> Password Manager</a></li>
                    <li><a href="password-generator.html"><span class="tool-icon">üîë</span> Password Generator</a></li>
                    <li><a href="qr-generator.html"><span class="tool-icon">üì±</span> QR Generator</a></li>
                </ul>
            </div>
             <div class="mega-menu-category">
                <h3>AI Tools</h3>
                <ul>
                    <li><a href="image-to-prompt.html"><span class="tool-icon">ü§ñ</span> Image to Prompt</a></li>
                    <li><a href="json-formatter.html"><span class="tool-icon">üß©</span> JSON Formatter</a></li>
                    <li><a href="html-viewer.html"><span class="tool-icon">üíª</span> HTML Viewer</a></li>
                </ul>
            </div>
        </div>
    </div>

    <main class="content tool-page">
        <section class="tool-card">
            <header class="tool-header">
                <h1>üîë Password Manager</h1>
                <p class="tool-desc">Securely store and manage your passwords directly in your browser. All data stays local and encrypted.</p>
            </header>

            <!-- Main Application Layout -->
            <div class="manager-layout" id="app">

                <!-- 1. Lock Screen (Initial Setup or Unlock) -->
                <div id="lockScreen">
                    <h2 id="lockTitle">Unlock Password Manager</h2>
                    <p id="lockDescription">Enter your master password to access your entries.</p>
                    <input type="password" id="masterPasswordInput" placeholder="Master Password" class="tool-input">
                    <button class="btn" id="setPasswordBtn">Unlock / Set Password</button>
                    <p id="lockError" style="color:red; margin-top: 0.5rem; display:none;">Incorrect password. Please try again.</p>
                </div>

                <!-- 2. Main Manager Content (Visible after unlock) -->
                <div id="managerContent" style="display: none;">
                    <!-- Search Bar -->
                    <input type="text" id="searchInput" placeholder="Search entries..." class="tool-input" style="margin-bottom: 1rem;">

                    <!-- New Entry Form -->
                    <h3 style="margin-bottom: 0.5rem;">Add New Entry</h3>
                    <form id="addEntryForm">
                        <input type="text" id="siteNameInput" placeholder="Site Name / Service" required class="tool-input">
                        <input type="text" id="usernameInput" placeholder="Username / Email" required class="tool-input">
                        <div style="display:flex; gap: 0.5rem; flex-wrap: wrap;">
                            <input type="password" id="passwordInput" placeholder="Password" required class="tool-input" style="flex-grow: 1;">
                            <button type="button" class="btn" id="generatePasswordBtn">Generate</button>
                        </div>
                        <button class="btn" type="submit">Save Entry</button>
                    </form>

                    <!-- Entries List -->
                    <h3 style="margin-top: 1.5rem;">Saved Entries (<span id="entryCount">0</span>)</h3>
                    <ul id="entryList" class="entry-list">
                        <!-- Entries will be dynamically added here -->
                    </ul>

                    <!-- Backup/Restore Controls -->
                    <div id="backupRestoreControls">
                        <button class="btn" id="exportBtn">Export Backup</button>
                        <button class="btn" id="importBtn">Import Backup</button>
                        <input type="file" id="importFile" accept=".json" style="display: none;">
                    </div>
                </div>
            </div>
        </section>

        <section class="how-to">
            <h3>How to Use</h3>
            <ol>
                <li>**Set Master Password:** The first time you visit, set a strong master password. This password encrypts all your data locally.</li>
                <li>**Add Entries:** Use the form to add new login details (site name, username, password).</li>
                <li>**Secure Access:** When you close and reopen the page, you will need the master password to unlock your entries.</li>
                <li>**Backup:** Use the "Export Backup" button to download a file containing your encrypted passwords. This file can be used to restore your data on another device.</li>
                <li>**Restore:** Use the "Import Backup" button to upload a backup file. Enter your Master Password to decrypt and restore your entries.</li>
            </ol>
        </section>
    </main>

    <!-- PWA Install Button -->
    <div class="pwa-install-container">
        <button class="btn" id="installButton" style="display:none;">Install App</button>
    </div>

    <footer class="main-footer">
        <ul class="footer-links">
            <li><a href="../about.html">About Us</a></li>
            <li><a href="../contact.html">Contact</a></li>
            <li><a href="../blog.html">Blog</a></li>
            <li><a href="../privacy.html">Privacy Policy</a></li>
            <li><a href="../disclaimer.html">Disclaimer</a></li>
        </ul>
        <p class="footer-copyright">&copy; 2025 ToolNine. All Tools Run in Your Browser.</p>
    </footer>

    <!-- Scripts -->
    <script src="../theme.js"></script>
    <!-- Include crypto-js library for encryption (Local processing) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Common Navigation and PWA Logic (keep as before) ---
            const hamburgerBtn = document.getElementById('hamburgerBtn');
            const allToolsMenu = document.getElementById('allToolsMenu');
            const themeToggle = document.getElementById('theme-toggle');

            // --- Navigation Logic ---
            // PWA install logic in separate files (index.html, other tool pages)

            // --- Password Manager Tool Specific Logic ---
            const lockScreen = document.getElementById('lockScreen');
            const lockTitle = document.getElementById('lockTitle');
            const lockDescription = document.getElementById('lockDescription');
            const masterPasswordInput = document.getElementById('masterPasswordInput');
            const setPasswordBtn = document.getElementById('setPasswordBtn');
            const lockError = document.getElementById('lockError');
            const managerContent = document.getElementById('managerContent');
            const entryList = document.getElementById('entryList');
            const entryCountSpan = document.getElementById('entryCount');
            const searchInput = document.getElementById('searchInput');

            // Form elements for adding new entries
            const addEntryForm = document.getElementById('addEntryForm');
            const siteNameInput = document.getElementById('siteNameInput');
            const usernameInput = document.getElementById('usernameInput');
            const passwordInput = document.getElementById('passwordInput');
            const generatePasswordBtn = document.getElementById('generatePasswordBtn');
            const exportBtn = document.getElementById('exportBtn');
            const importBtn = document.getElementById('importBtn');
            const importFile = document.getElementById('importFile');

            const storageKey = 'ToolNinePasswordData';
            let masterPasswordHash = '';
            let currentEntries = [];

            // --- Encryption/Decryption Functions (using CryptoJS) ---
            function encryptData(data, key) {
                return CryptoJS.AES.encrypt(JSON.stringify(data), key).toString();
            }

            function decryptData(ciphertext, key) {
                try {
                    const bytes = CryptoJS.AES.decrypt(ciphertext, key);
                    return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
                } catch (e) {
                    return null; // Decryption failed
                }
            }

            // --- Password Generator Logic (Integrated) ---
            function generateRandomPassword(length = 16) {
                const lowercaseChars = 'abcdefghijklmnopqrstuvwxyz';
                const uppercaseChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                const numberChars = '0123456789';
                const symbolChars = '!@#$%^&*()_+~`|}{[]\:;?><,./-=';
                let availableChars = lowercaseChars + uppercaseChars + numberChars + symbolChars;
                let password = '';

                const cryptoArray = new Uint32Array(length);
                window.crypto.getRandomValues(cryptoArray);

                for (let i = 0; i < length; i++) {
                    password += availableChars[cryptoArray[i] % availableChars.length];
                }
                return password;
            }
            generatePasswordBtn.addEventListener('click', () => {
                passwordInput.value = generateRandomPassword();
            });

            // --- Load, Save, Render Logic ---
            function loadAndDecryptEntries(key) {
                const encryptedData = localStorage.getItem(storageKey);
                if (encryptedData) {
                    const decryptedData = decryptData(encryptedData, key);
                    currentEntries = decryptedData || [];
                    return !!decryptedData; // Return true if decryption succeeded
                } else {
                    currentEntries = [];
                    return true; // No encrypted data yet, treat as success (new user)
                }
            }

            function saveAndEncryptEntries() {
                const encryptedData = encryptData(currentEntries, masterPasswordHash);
                localStorage.setItem(storageKey, encryptedData);
            }

            function renderEntries(filter = '') {
                entryList.innerHTML = '';
                let visibleCount = 0;
                const filteredEntries = currentEntries.filter(entry =>
                    entry.site.toLowerCase().includes(filter.toLowerCase()) ||
                    entry.username.toLowerCase().includes(filter.toLowerCase())
                );

                filteredEntries.forEach((entry, index) => {
                    visibleCount++;
                    const item = document.createElement('li');
                    item.className = 'entry-item';
                    item.innerHTML = `
                        <div class="entry-details">
                            <strong>${entry.site}</strong><br>
                            <span class="username-display">${entry.username}</span>
                            <input type="password" value="${entry.password}" readonly style="display:none; border:none; background:none; color:inherit; font-size: inherit; width: 100%;">
                        </div>
                        <div class="entry-actions">
                            <button class="btn show-password-btn" data-index="${index}">Show/Hide</button>
                            <button class="btn delete-entry-btn" data-index="${index}">Delete</button>
                        </div>
                    `;
                    entryList.appendChild(item);
                });
                entryCountSpan.textContent = visibleCount;
            }

            // --- Event Listeners ---
            addEntryForm.addEventListener('submit', (event) => {
                event.preventDefault();
                const newEntry = {
                    site: siteNameInput.value,
                    username: usernameInput.value,
                    password: passwordInput.value,
                    id: Date.now() // Simple unique ID
                };
                currentEntries.push(newEntry);
                saveAndEncryptEntries();
                renderEntries();
                addEntryForm.reset();
            });

            entryList.addEventListener('click', (event) => {
                if (event.target.classList.contains('delete-entry-btn')) {
                    const index = parseInt(event.target.dataset.index);
                    currentEntries.splice(index, 1);
                    saveAndEncryptEntries();
                    renderEntries();
                } else if (event.target.classList.contains('show-password-btn')) {
                    const entryItem = event.target.closest('.entry-item');
                    const passwordInputEl = entryItem.querySelector('input[type="password"]');
                    const usernameEl = entryItem.querySelector('.username-display');
                    
                    // Toggle visibility of password input field
                    if (passwordInputEl.type === 'password') {
                        passwordInputEl.type = 'text';
                        passwordInputEl.style.display = 'block';
                        usernameEl.style.display = 'none';
                    } else {
                        passwordInputEl.type = 'password';
                        passwordInputEl.style.display = 'none';
                        usernameEl.style.display = 'block';
                    }
                }
            });

            searchInput.addEventListener('input', () => {
                renderEntries(searchInput.value);
            });

            // --- Master Password Logic ---
            setPasswordBtn.addEventListener('click', () => {
                const password = masterPasswordInput.value;
                if (!password) {
                    lockError.textContent = 'Please enter a password.';
                    lockError.style.display = 'block';
                    return;
                }

                masterPasswordHash = password;
                if (localStorage.getItem(storageKey)) {
                    // Unlock existing data
                    if (loadAndDecryptEntries(masterPasswordHash)) {
                        unlockManager();
                    } else {
                        lockError.textContent = 'Incorrect master password.';
                        lockError.style.display = 'block';
                    }
                } else {
                    // Set new master password and initialize empty data
                    unlockManager();
                    saveAndEncryptEntries(); // Save empty array initially
                }
            });

            function unlockManager() {
                loadAndDecryptEntries(masterPasswordHash);
                renderEntries();
                lockScreen.style.display = 'none';
                managerContent.style.display = 'block';
                lockError.style.display = 'none'; // Clear error message on success
            }

            // Check if master password exists on load
            if (localStorage.getItem(storageKey)) {
                lockTitle.textContent = 'Unlock Password Manager';
                lockDescription.textContent = 'Enter your master password to access your entries.';
                setPasswordBtn.textContent = 'Unlock';
            } else {
                lockTitle.textContent = 'Set Master Password';
                lockDescription.textContent = 'Create a strong master password to secure your local data.';
                setPasswordBtn.textContent = 'Set Password';
            }

            // --- Import/Export Logic ---
            exportBtn.addEventListener('click', () => {
                if (!masterPasswordHash) {
                    alert('Please unlock the manager first.');
                    return;
                }
                const encryptedData = encryptData(currentEntries, masterPasswordHash);
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(encryptedData);
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "ToolNine-password-backup.json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            });

            importBtn.addEventListener('click', () => {
                importFile.click(); // Trigger file selection on button click
            });

            importFile.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    const encryptedImportData = e.target.result;
                    const passwordPrompt = prompt("Enter your master password to import data:");
                    if (passwordPrompt) {
                        const decryptedImportEntries = decryptData(encryptedImportData, passwordPrompt);
                        if (decryptedImportEntries) {
                            if (confirm('Importing will replace existing data. Continue?')) {
                                currentEntries = decryptedImportEntries;
                                saveAndEncryptEntries(); // Save the new data using current master password
                                renderEntries();
                                alert('Data imported successfully!');
                            }
                        } else {
                            alert('Import failed: Incorrect password or corrupted file.');
                        }
                    }
                };
                reader.readAsText(file);
            });
        });
    </script>
</body>
</html>
